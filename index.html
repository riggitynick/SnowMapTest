<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SnowMap Prototype</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  font-family: system-ui, sans-serif;
}

#map { height: 100%; }

#hud {
  position: fixed;
  top: 10px;
  left: 10px;
  background: rgba(0,0,0,0.6);
  color: white;
  padding: 10px;
  border-radius: 8px;
  font-size: 14px;
  z-index: 1000;
}

#radar {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 120px;
  height: 120px;
  border-radius: 50%;
  border: 2px solid #00ffcc;
  background: rgba(0,255,204,0.1);
  animation: pulse 2s infinite;
  z-index: 1000;
}

@keyframes pulse {
  0% { box-shadow: 0 0 5px rgba(0,255,204,0.3); }
  100% { box-shadow: 0 0 20px rgba(0,255,204,0.8); }
}

#runSummary {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  color: white;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
}

#runCard {
  background: #111;
  padding: 20px;
  border-radius: 12px;
  width: 90%;
  max-width: 400px;
  text-align: center;
}

#runCard input {
  width: 100%;
  padding: 8px;
  margin-top: 10px;
  font-size: 16px;
}

#runCard button {
  margin-top: 10px;
  padding: 10px;
  width: 100%;
  font-size: 16px;
  cursor: pointer;
}
</style>
</head>

<body>

<div id="map"></div>

<div id="hud">
  Points: <span id="points">0</span><br>
  Streak: <span id="streak">0</span> day(s)<br>
  Status: <span id="status">Waiting for GPS</span>
</div>

<div id="radar"></div>

<div id="runSummary">
  <div id="runCard">
    <h2>üèÅ Run Complete</h2>
    <p id="runStats"></p>
    <input id="runNameInput" placeholder="Name this run">
    <button onclick="saveRun()">Save Run</button>
  </div>
</div>

<audio id="ding" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// =======================
// STATE
// =======================
let map, userMarker;
let lastPosition = null;
let points = Number(localStorage.getItem("points")) || 0;

let collectibles = [];
let collectedIds = JSON.parse(localStorage.getItem("collected")) || [];

let streakData = JSON.parse(localStorage.getItem("streak")) || { last: null, count: 0 };

let run = null;
let savedRuns = JSON.parse(localStorage.getItem("runs")) || [];

// =======================
// INIT MAP
// =======================
map = L.map('map').setView([0,0], 18);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

userMarker = L.circleMarker([0,0], {
  radius: 8,
  color: '#00ffff'
}).addTo(map);

// =======================
// UI INIT
// =======================
document.getElementById("points").textContent = points;

// =======================
// STREAK
// =======================
function updateStreak() {
  const today = new Date().toDateString();
  if (streakData.last !== today) {
    const yesterday = new Date(Date.now() - 86400000).toDateString();
    streakData.count = (streakData.last === yesterday) ? streakData.count + 1 : 1;
    streakData.last = today;
    localStorage.setItem("streak", JSON.stringify(streakData));
  }
  document.getElementById("streak").textContent = streakData.count;
}
updateStreak();

// =======================
// COLLECTIBLES
// =======================
function spawnCollectibles(center) {
  for (let i = 0; i < 10; i++) {
    const id = "c_" + i;
    if (collectedIds.includes(id)) continue;

    const lat = center.lat + (Math.random()-0.5)/5000;
    const lng = center.lng + (Math.random()-0.5)/5000;

    const marker = L.circleMarker([lat,lng], {
      radius: 6,
      color: i%3===0 ? "gold" : i%3===1 ? "cyan" : "magenta"
    }).addTo(map);

    collectibles.push({ id, lat, lng, marker, radius: 8, points: 10 });
  }
}

// =======================
// RUN SYSTEM (NEW)
// =======================
function startRun(pos) {
  run = {
    start: Date.now(),
    path: [[pos.lat, pos.lng]],
    distance: 0
  };
}

function endRun() {
  if (!run) return;

  const time = Math.floor((Date.now() - run.start)/1000);
  const name = generateRunName();

  document.getElementById("runStats").innerHTML =
    `Time: ${time}s<br>Distance: ${run.distance.toFixed(2)} m`;

  document.getElementById("runNameInput").value = name;
  document.getElementById("runSummary").style.display = "flex";
}

function saveRun() {
  const name = document.getElementById("runNameInput").value;
  run.name = name;
  savedRuns.push(run);
  localStorage.setItem("runs", JSON.stringify(savedRuns));
  document.getElementById("runSummary").style.display = "none";
  run = null;
}

function generateRunName() {
  const names = ["Powder Snake","Stormline","Frostbite","Glade Rush","White Fang"];
  return names[Math.floor(Math.random()*names.length)];
}

// =======================
// GPS
// =======================
navigator.geolocation.watchPosition(pos => {
  const lat = pos.coords.latitude;
  const lng = pos.coords.longitude;

  document.getElementById("status").textContent = "GPS Active";

  userMarker.setLatLng([lat,lng]);
  map.setView([lat,lng], 18);

  if (!lastPosition) {
    spawnCollectibles({lat,lng});
    startRun({lat,lng});
  } else {
    const d = map.distance([lat,lng], lastPosition);
    if (run) {
      run.distance += d;
      run.path.push([lat,lng]);
    }

    // STOP detection
    if (d < 0.5 && run) {
      setTimeout(() => run && endRun(), 10000);
    }
  }

  // Collectibles
  collectibles.forEach(c => {
    if (!c.marker) return;
    const dist = map.distance([lat,lng],[c.lat,c.lng]);
    if (dist < c.radius) {
      points += c.points;
      document.getElementById("points").textContent = points;
      localStorage.setItem("points", points);
      collectedIds.push(c.id);
      localStorage.setItem("collected", JSON.stringify(collectedIds));
      map.removeLayer(c.marker);
      c.marker = null;
      document.getElementById("ding").play();
    }
  });

  lastPosition = [lat,lng];

}, err => {
  document.getElementById("status").textContent = "GPS Error";
}, {
  enableHighAccuracy: true,
  maximumAge: 500,
  timeout: 10000
});
</script>

</body>
</html>
