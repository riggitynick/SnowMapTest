<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Location Collectibles Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    #status, #points {
      position: absolute;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 14px;
      z-index: 1000;
    }

    #status { top: 10px; }
    #points { top: 50px; }

    #unlock {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 16px;
      font-size: 14px;
      z-index: 1000;
    }
    #reset {
  position: absolute;
  top: 90px;
  left: 10px;
  z-index: 1000;
  padding: 6px 10px;
}
  </style>
</head>
<body>

<div id="map"></div>
<div id="status">Initializingâ€¦</div>
<div id="points">Points: 0</div>
<button id="reset">Reset Points</button>


<script>
  // --------------------
  // BASIC STATE
  // --------------------
  let points = parseInt(localStorage.getItem("points")) || 0;
  let playerLat = null;
  let playerLng = null;

document.getElementById("points").textContent = `Points: ${points}`;

 function addPoints(amount) {
  points += amount;
  localStorage.setItem("points", points);
  document.getElementById("points").textContent = `Points: ${points}`;
}

  // --------------------
  // AUDIO (UNLOCKED BY TAP)
  // --------------------
  const ding = new Audio(
    "https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"
  );

  document.getElementById("unlock").addEventListener("click", () => {
    ding.play().catch(() => {});
    document.getElementById("unlock").style.display = "none";
  });

  function playDing() {
    ding.currentTime = 0;
    ding.play();
  }

  // --------------------
  // MAP SETUP
  // --------------------
  const map = L.map("map").setView([0, 0], 18);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
  }).addTo(map);

  const playerMarker = L.circleMarker([0, 0], {
    radius: 8,
    color: "cyan",
    fillColor: "cyan",
    fillOpacity: 1
  }).addTo(map);

  // --------------------
  // COLLECTIBLES
  // --------------------
  const collectibles = Array.from({ length: 10 }, (_, i) => ({
    id: i + 1,
    lat: 0,
    lng: 0,
    radius: 30, // meters (large for testing)
    points: 100,
    collected: false,
    marker: null
  }));

  map.on("click", (e) => {
    const c = collectibles.find(x => x.lat === 0);
    if (!c) {
      alert("All collectibles placed!");
      return;
    }

    c.lat = e.latlng.lat;
    c.lng = e.latlng.lng;

    c.marker = L.circleMarker([c.lat, c.lng], {
      radius: 8,
      color: "gold",
      fillColor: "yellow",
      fillOpacity: 0.9
    }).addTo(map);

    console.log("Placed collectible", c.id);
  });

  // --------------------
  // DISTANCE FUNCTION
  // --------------------
  function distanceInMeters(lat1, lng1, lat2, lng2) {
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;

    const dLat = toRad(lat2 - lat1);
    const dLng = toRad(lng2 - lng1);

    const a =
      Math.sin(dLat / 2) ** 2 +
      Math.cos(toRad(lat1)) *
        Math.cos(toRad(lat2)) *
        Math.sin(dLng / 2) ** 2;

    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }

  // --------------------
  // GPS GAME LOOP
  // --------------------
  function success(position) {
    playerLat = position.coords.latitude;
    playerLng = position.coords.longitude;

    document.getElementById("status").textContent =
      `Accuracy: ${Math.round(position.coords.accuracy)}m`;

    playerMarker.setLatLng([playerLat, playerLng]);
    map.setView([playerLat, playerLng]);

    collectibles.forEach(c => {
      if (c.collected || c.lat === 0) return;

      const d = distanceInMeters(
        playerLat,
        playerLng,
        c.lat,
        c.lng
      );

      console.log(`Distance to ${c.id}:`, Math.round(d));

      if (d < c.radius) {
        c.collected = true;
        addPoints(c.points);
        map.removeLayer(c.marker);
        playDing();
      }
    });
  }

  function error(err) {
    document.getElementById("status").textContent =
      "Location error";
    console.error(err);
  }

  if ("geolocation" in navigator) {
    navigator.geolocation.watchPosition(
      success,
      error,
      {
        enableHighAccuracy: true,
        maximumAge: 1000,
        timeout: 10000
      }
    );
  } else {
    document.getElementById("status").textContent =
      "Geolocation not supported";
  }

  // Reset Points
  document.getElementById("reset").addEventListener("click", () => {
  if (confirm("Reset points?")) {
    points = 0;
    localStorage.setItem("points", points);
    document.getElementById("points").textContent = `Points: ${points}`;
  }
});


</script>

</body>
</html>
