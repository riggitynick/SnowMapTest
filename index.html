<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AR Outdoor Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html, body { margin:0; padding:0; height:100%; }
#map { height:100%; }

#hud {
  position: fixed;
  top: 10px;
  left: 10px;
  background: rgba(0,0,0,0.7);
  color: white;
  padding: 12px;
  border-radius: 14px;
  font-family: system-ui, sans-serif;
  z-index: 1000;
}

#radar {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 140px;
  height: 140px;
  border-radius: 50%;
  border: 2px solid lime;
  background: rgba(0,255,0,0.08);
  z-index: 1000;
  overflow: hidden;
}

.radar-dot {
  position: absolute;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  transform: translate(-50%, -50%);
}

/* Direction arrow */
#arrow {
  position: fixed;
  bottom: 190px;
  right: 65px;
  width: 0;
  height: 0;
  border-left: 18px solid transparent;
  border-right: 18px solid transparent;
  border-bottom: 36px solid cyan;
  transform-origin: 50% 70%;
  z-index: 1000;
  transition: border-bottom-color 0.3s ease;
}

/* Snowboard mode */
.snowboard #arrow {
  border-left: 28px solid transparent;
  border-right: 28px solid transparent;
  border-bottom: 56px solid cyan;
}

/* Pulse */
@keyframes pulse {
  0% { transform: scale(1) rotate(var(--angle)); opacity: 0.7; }
  50% { transform: scale(1.35) rotate(var(--angle)); opacity: 1; }
  100% { transform: scale(1) rotate(var(--angle)); opacity: 0.7; }
}

#status {
  position: fixed;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.7);
  color: white;
  padding: 6px 12px;
  border-radius: 10px;
  font-size: 12px;
  z-index: 1000;
}

/* Snowboard toggle */
#toggle {
  position: fixed;
  top: 10px;
  right: 10px;
  background: rgba(255,255,255,0.9);
  border-radius: 12px;
  padding: 10px;
  font-size: 14px;
  z-index: 1000;
}
</style>
</head>

<body>
<div id="map"></div>

<div id="hud">
  <div id="level"></div>
  <div id="points"></div>
  <div id="streak"></div>
</div>

<div id="toggle">üèÇ Mode</div>
<div id="arrow"></div>
<div id="radar"></div>
<div id="status">üì° Waiting for GPS‚Ä¶</div>

<audio id="ding" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
<audio id="pulse" src="https://actions.google.com/sounds/v1/alarms/heartbeat.ogg" loop></audio>

<script>
/* =====================
   STATE
===================== */
let points = parseInt(localStorage.getItem("points")) || 0;
let level = parseInt(localStorage.getItem("level")) || 1;
let snowboardMode = false;

/* Daily streak */
const today = new Date().toDateString();
const lastDay = localStorage.getItem("lastPlayDay");
let streak = parseInt(localStorage.getItem("streak")) || 0;

if (lastDay !== today) {
  streak += 1;
  localStorage.setItem("streak", streak);
  localStorage.setItem("lastPlayDay", today);
}

const RARITIES = {
  common: { color: "cyan", points: 100, signal: 1 },
  rare: { color: "orange", points: 250, signal: 1.4 },
  epic: { color: "red", points: 500, signal: 1.8 }
};

const collectibles = [];
let playerLat=null, playerLng=null;

/* =====================
   MAP
===================== */
const map = L.map("map");
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);
let playerMarker=null, centered=false;

/* =====================
   UI
===================== */
function updateUI(){
  level=Math.floor(points/500)+1;
  localStorage.setItem("points",points);
  localStorage.setItem("level",level);
  document.getElementById("level").textContent=`Level ${level}`;
  document.getElementById("points").textContent=`Points ${points}`;
  document.getElementById("streak").textContent=`üî• ${streak} Day Streak`;
}
updateUI();

/* =====================
   HELPERS
===================== */
const playDing=()=>document.getElementById("ding").play();
const pulseSound=document.getElementById("pulse");

function distance(a,b,c,d){
  const R=6371000,toRad=x=>x*Math.PI/180;
  const dLat=toRad(c-a),dLng=toRad(d-b);
  const x=Math.sin(dLat/2)**2+
    Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dLng/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

function bearing(lat1,lon1,lat2,lon2){
  const toRad=x=>x*Math.PI/180,toDeg=x=>x*180/Math.PI;
  const y=Math.sin(toRad(lon2-lon1))*Math.cos(toRad(lat2));
  const x=Math.cos(toRad(lat1))*Math.sin(toRad(lat2))-
          Math.sin(toRad(lat1))*Math.cos(toRad(lat2))*Math.cos(toRad(lon2-lon1));
  return (toDeg(Math.atan2(y,x))+360)%360;
}

/* =====================
   RADAR
===================== */
function updateRadar(){
  const radar=document.getElementById("radar");
  radar.innerHTML="";
  if(!playerLat) return;
  const maxRange=120,size=140,center=size/2;

  collectibles.forEach(c=>{
    if(c.collected) return;
    const d=distance(playerLat,playerLng,c.lat,c.lng);
    if(d>maxRange) return;
    const angle=bearing(playerLat,playerLng,c.lat,c.lng)*Math.PI/180;
    const r=(d/maxRange)*(center-8);
    const dot=document.createElement("div");
    dot.className="radar-dot";
    dot.style.left=(center+r*Math.sin(angle))+"px";
    dot.style.top=(center-r*Math.cos(angle))+"px";
    dot.style.background=RARITIES[c.rarity].color;
    radar.appendChild(dot);
  });
}

/* =====================
   DIRECTION + HOT/COLD
===================== */
function updateArrow(){
  if(!playerLat) return;
  let nearest=null, nearestDist=Infinity;

  collectibles.forEach(c=>{
    if(c.collected) return;
    const d=distance(playerLat,playerLng,c.lat,c.lng)/RARITIES[c.rarity].signal;
    if(d<nearestDist){ nearest=c; nearestDist=d; }
  });

  const arrow=document.getElementById("arrow");
  if(!nearest){
    arrow.style.display="none";
    pulseSound.pause();
    return;
  }

  arrow.style.display="block";
  const angle=bearing(playerLat,playerLng,nearest.lat,nearest.lng);
  arrow.style.setProperty("--angle",`${angle}deg`);
  arrow.style.transform=`rotate(${angle}deg)`;

  const maxDist=140;
  const heat=1-(Math.min(nearestDist,maxDist)/maxDist);
  const speed=(1.8-heat*1.4).toFixed(2);

  arrow.style.animation=`pulse ${speed}s infinite`;

  if(heat>0.66) arrow.style.borderBottomColor="red";
  else if(heat>0.33) arrow.style.borderBottomColor="orange";
  else arrow.style.borderBottomColor="cyan";

  if(pulseSound.paused){
    pulseSound.volume=0.4;
    pulseSound.play();
  }
}

/* =====================
   COLLECTIBLES
===================== */
map.on("click",e=>{
  let roll=Math.random(), rarity="common";
  if(roll>0.9) rarity="epic";
  else if(roll>0.7) rarity="rare";

  const c={lat:e.latlng.lat,lng:e.latlng.lng,rarity,collected:false};
  c.marker=L.circleMarker([c.lat,c.lng],{
    radius:9,color:RARITIES[rarity].color,fillOpacity:0.9
  }).addTo(map);
  collectibles.push(c);
});

/* =====================
   GPS
===================== */
navigator.geolocation.watchPosition(
  pos=>{
    playerLat=pos.coords.latitude;
    playerLng=pos.coords.longitude;
    document.getElementById("status").textContent=`üìç Accuracy ${Math.round(pos.coords.accuracy)}m`;

    if(!playerMarker){
      playerMarker=L.circleMarker([playerLat,playerLng],{
        radius:6,color:"lime",fillOpacity:1
      }).addTo(map);
    } else playerMarker.setLatLng([playerLat,playerLng]);

    if(!centered){
      map.setView([playerLat,playerLng],18);
      centered=true;
    }

    collectibles.forEach(c=>{
      if(c.collected) return;
      if(distance(playerLat,playerLng,c.lat,c.lng)<30){
        c.collected=true;
        map.removeLayer(c.marker);
        points+=RARITIES[c.rarity].points;
        playDing();
        updateUI();
      }
    });

    updateRadar();
    updateArrow();
  },
  err=>console.error(err),
  { enableHighAccuracy:true, maximumAge:0, timeout:5000 }
);

/* =====================
   SNOWBOARD MODE
===================== */
document.getElementById("toggle").onclick=()=>{
  snowboardMode=!snowboardMode;
  document.body.classList.toggle("snowboard",snowboardMode);
};
</script>
</body>
</html>
