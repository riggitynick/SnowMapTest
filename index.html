<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AR Collectibles Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    #status, #points {
      position: absolute;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 14px;
      z-index: 1000;
    }

    #status { top: 10px; }
    #points { top: 50px; }
    #level {
  position: absolute;
  top: 90px;
  left: 10px;
  background: rgba(0,0,0,0.7);
  color: white;
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 14px;
  z-index: 1000;
}


    #unlock, #reset {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 14px;
      font-size: 14px;
      z-index: 1000;
    }

    #unlock { bottom: 60px; }
    #reset { bottom: 20px; }

    #resetItems {
  position: absolute;
  bottom: 100px;
  left: 50%;
  transform: translateX(-50%);
  padding: 8px 14px;
  z-index: 1000;
}
  </style>
</head>
<body>

<div id="map"></div>
<div id="status">Initializingâ€¦</div>
<div id="points">Points: 0</div>
<div id="level">Level: 1</div>

<button id="unlock">Tap to Enable Sound</button>
<button id="resetItems">Reset Items</button>
<button id="reset">Reset Points</button>

<script>
  // --------------------
  // POINTS (PERSISTENT)
  // --------------------
  let points = parseInt(localStorage.getItem("points")) || 0;
  document.getElementById("points").textContent = `Points: ${points}`;

function addPoints(amount) {
  points += amount;
  localStorage.setItem("points", points);
  document.getElementById("points").textContent = `Points: ${points}`;
  checkLevelUp();
}


  function checkLevelUp() {
  const newLevel = Math.floor(points / 500) + 1;

  if (newLevel > level) {
    level = newLevel;
    localStorage.setItem("level", level);
    document.getElementById("level").textContent = `Level: ${level}`;
    playDing();
    console.log("LEVEL UP! You are now level", level);
  }
}


  // LEVEL STORAGE
  let level = parseInt(localStorage.getItem("level")) || 1;
document.getElementById("level").textContent = `Level: ${level}`;


  document.getElementById("reset").addEventListener("click", () => {
    if (confirm("Reset points?")) {
      points = 0;
      localStorage.setItem("points", points);
      document.getElementById("points").textContent = `Points: ${points}`;
    }
  });

  //WORLD MEMORY
  let collectedIds = JSON.parse(localStorage.getItem("collectedIds")) || [];


  // --------------------
  // AUDIO
  // --------------------
  const ding = new Audio(
    "https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"
  );

  document.getElementById("unlock").addEventListener("click", () => {
    ding.play().catch(() => {});
    document.getElementById("unlock").style.display = "none";
  });

  function playDing() {
    ding.currentTime = 0;
    ding.play();
  }

  // --------------------
  // MAP
  // --------------------
  const map = L.map("map").setView([0, 0], 18);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
  }).addTo(map);

  const playerMarker = L.circleMarker([0, 0], {
    radius: 8,
    color: "cyan",
    fillColor: "cyan",
    fillOpacity: 1
  }).addTo(map);

  // --------------------
  // COLLECTIBLES
  // --------------------
  const collectibles = Array.from({ length: 10 }, (_, i) => {
  const id = i + 1;
  return {
    id,
    lat: 0,
    lng: 0,
    radius: 30,
    points: 100,
    collected: collectedIds.includes(id),
    marker: null
  };
});


map.on("click", (e) => {
  const c = collectibles.find(x => x.lat === 0 && !x.collected);
  if (!c) {
    alert("All collectibles placed!");
    return;
  }

  c.lat = e.latlng.lat;
  c.lng = e.latlng.lng;

  if (c.collected) return;

  c.marker = L.circleMarker([c.lat, c.lng], {
    radius: 8,
    color: "gold",
    fillColor: "yellow",
    fillOpacity: 0.9
  }).addTo(map);
});


  // --------------------
  // DISTANCE MATH
  // --------------------
  function distanceInMeters(lat1, lng1, lat2, lng2) {
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;

    const dLat = toRad(lat2 - lat1);
    const dLng = toRad(lng2 - lng1);

    const a =
      Math.sin(dLat / 2) ** 2 +
      Math.cos(toRad(lat1)) *
      Math.cos(toRad(lat2)) *
      Math.sin(dLng / 2) ** 2;

    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }

  // --------------------
  // GPS GAME LOOP
  // --------------------
  function success(position) {
    const lat = position.coords.latitude;
    const lng = position.coords.longitude;

    document.getElementById("status").textContent =
      `Accuracy: ${Math.round(position.coords.accuracy)}m`;

    playerMarker.setLatLng([lat, lng]);
    map.setView([lat, lng]);

    collectibles.forEach(c => {
      if (c.collected || c.lat === 0) return;

      const d = distanceInMeters(lat, lng, c.lat, c.lng);

    if (d < c.radius) {
  c.collected = true;
  collectedIds.push(c.id);
  localStorage.setItem("collectedIds", JSON.stringify(collectedIds));
  addPoints(c.points);
  map.removeLayer(c.marker);
  playDing();
}

    });
  }

  function error(err) {
    console.error(err);
    document.getElementById("status").textContent = "Location error";
  }

  if ("geolocation" in navigator) {
    navigator.geolocation.watchPosition(
      success,
      error,
      {
        enableHighAccuracy: true,
        maximumAge: 1000,
        timeout: 10000
      }
    );
  } else {
    document.getElementById("status").textContent =
      "Geolocation not supported";
  }

  document.getElementById("resetItems").addEventListener("click", () => {
  if (confirm("Reset collected items?")) {
    localStorage.removeItem("collectedIds");
    location.reload();
  }
});


</script>

</body>
</html>
