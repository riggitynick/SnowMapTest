<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mountain AR Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html, body { margin:0; padding:0; height:100%; background:black; }
#map { height:100%; }

#hud {
  position: fixed;
  top: 10px;
  left: 10px;
  background: rgba(0,0,0,0.75);
  color: white;
  padding: 12px;
  border-radius: 14px;
  font-family: system-ui, sans-serif;
  z-index: 1000;
}

#radar {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 140px;
  height: 140px;
  border-radius: 50%;
  border: 2px solid cyan;
  background: rgba(0,255,255,0.05);
  z-index: 1000;
}

#arrow {
  position: fixed;
  bottom: 190px;
  right: 70px;
  width: 0;
  height: 0;
  border-left: 18px solid transparent;
  border-right: 18px solid transparent;
  border-bottom: 36px solid cyan;
  z-index: 1000;
}

#status {
  position: fixed;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.75);
  color: white;
  padding: 6px 12px;
  border-radius: 10px;
  font-size: 12px;
  z-index: 1000;
}
</style>
</head>

<body>
<div id="map"></div>

<div id="hud">
  <div id="level"></div>
  <div id="points"></div>
  <div id="streak"></div>
  <div id="run"></div>
</div>

<div id="arrow"></div>
<div id="radar"></div>
<div id="status">ðŸ“¡ Waiting for GPSâ€¦</div>

<audio id="ding" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
<audio id="pulse" src="https://actions.google.com/sounds/v1/alarms/heartbeat.ogg" loop></audio>

<script>
/* =====================
   PERSISTENT STATE
===================== */
let points = parseInt(localStorage.getItem("points")) || 0;

const today = new Date().toDateString();
let lastDay = localStorage.getItem("lastPlayDay");
let streak = parseInt(localStorage.getItem("streak")) || 0;

if (lastDay !== today) {
  streak += 1;
  localStorage.setItem("streak", streak);
  localStorage.setItem("lastPlayDay", today);
}

let level = Math.floor(points / 500) + 1;

/* =====================
   RARITIES
===================== */
const RARITIES = {
  common: { color: "cyan", points: 100, chance: 0.7 },
  rare: { color: "orange", points: 250, chance: 0.2 },
  epic: { color: "red", points: 500, chance: 0.1 }
};

/* =====================
   MAP
===================== */
const map = L.map("map");
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

let centered = false;
let playerMarker = null;

/* =====================
   GAME OBJECTS
===================== */
const collectibles = [];

/* =====================
   RUN + GHOST
===================== */
let runActive = false;
let runDistance = 0;
let runCollects = 0;
let lastPos = null;

let bestRun = JSON.parse(localStorage.getItem("bestRun")) || null;
let ghostMarker = null;
let ghostProgress = 0;

/* =====================
   HELPERS
===================== */
function distance(a,b,c,d){
  const R=6371000,toRad=x=>x*Math.PI/180;
  const dLat=toRad(c-a),dLng=toRad(d-b);
  const x=Math.sin(dLat/2)**2 +
    Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dLng/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

function updateUI(){
  level = Math.floor(points / 500) + 1;
  localStorage.setItem("points", points);
  document.getElementById("level").textContent = `Level ${level}`;
  document.getElementById("points").textContent = `Points ${points}`;
  document.getElementById("streak").textContent = `ðŸ”¥ ${streak} Day Streak`;
  document.getElementById("run").textContent =
    runActive ? `ðŸ‚ Run: ${Math.round(runDistance)}m | ðŸŽ¯ ${runCollects}` : "";
}
updateUI();

/* =====================
   GPS LOOP
===================== */
navigator.geolocation.watchPosition(
pos => {
  const lat = pos.coords.latitude;
  const lng = pos.coords.longitude;

  document.getElementById("status").textContent = "ðŸ‚ Riding";

  if (!playerMarker) {
    playerMarker = L.circleMarker([lat, lng], {
      radius: 6, color: "lime", fillOpacity: 1
    }).addTo(map);
  } else {
    playerMarker.setLatLng([lat, lng]);
  }

  if (!centered) {
    map.setView([lat, lng], 18);
    centered = true;
  }

  /* RUN START */
  if (!runActive) {
    runActive = true;
    runDistance = 0;
    runCollects = 0;
    lastPos = [lat, lng];
    ghostProgress = 0;

    if (bestRun) {
      ghostMarker = L.circleMarker([lat, lng], {
        radius: 6,
        color: "white",
        opacity: 0.5
      }).addTo(map);
    }
  }

  /* RUN UPDATE */
  if (lastPos) {
    const d = distance(lastPos[0], lastPos[1], lat, lng);
    runDistance += d;
    lastPos = [lat, lng];

    if (ghostMarker && bestRun) {
      ghostProgress += d;
      const ratio = Math.min(1, ghostProgress / bestRun.distance);
      const gLat = lat + (bestRun.end[0] - lat) * ratio;
      const gLng = lng + (bestRun.end[1] - lng) * ratio;
      ghostMarker.setLatLng([gLat, gLng]);
    }
  }

  /* COLLECTIBLES + HOT/COLD */
  let nearest = Infinity;
  collectibles.forEach(c => {
    if (c.collected) return;
    const d = distance(lat, lng, c.lat, c.lng);
    nearest = Math.min(nearest, d);

    if (d < 25) {
      c.collected = true;
      map.removeLayer(c.marker);
      points += RARITIES[c.rarity].points;
      runCollects++;
      document.getElementById("ding").play();
      updateUI();
    }
  });

  const pulse = document.getElementById("pulse");
  if (nearest < 200) {
    const intensity = Math.max(0.4, 2 - nearest / 100);
    pulse.playbackRate = intensity;
    pulse.volume = Math.min(1, intensity / 2);
    pulse.play();
    document.getElementById("radar").style.borderColor =
      nearest < 50 ? "red" : nearest < 100 ? "orange" : "cyan";
  } else {
    pulse.pause();
  }

},
err => console.error(err),
{ enableHighAccuracy:true, maximumAge:0, timeout:5000 }
);

/* =====================
   SPAWNING
===================== */
map.on("click", e => {
  let roll = Math.random();
  let rarity = roll < 0.7 ? "common" : roll < 0.9 ? "rare" : "epic";

  const c = {
    lat: e.latlng.lat,
    lng: e.latlng.lng,
    rarity,
    collected: false
  };

  c.marker = L.circleMarker([c.lat, c.lng], {
    radius: 9,
    color: RARITIES[rarity].color,
    fillOpacity: 0.9
  }).addTo(map);

  collectibles.push(c);
});
</script>
</body>
</html>
