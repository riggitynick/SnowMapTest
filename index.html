<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AR Collectibles Prototype</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html, body { margin:0; padding:0; height:100%; }
#map { height:100%; }

#hud {
  position: fixed;
  top: 10px;
  left: 10px;
  background: rgba(0,0,0,0.7);
  color: white;
  padding: 12px 14px;
  border-radius: 12px;
  font-family: system-ui, sans-serif;
  font-size: 14px;
  z-index: 1000;
}

#streak { color: orange; font-weight: bold; }
#challenge { margin-top: 6px; font-size: 13px; }
#status {
  position: fixed;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.7);
  color: white;
  padding: 6px 10px;
  border-radius: 10px;
  font-size: 12px;
  z-index: 1000;
}
</style>
</head>

<body>
<div id="map"></div>

<div id="hud">
  <div id="level"></div>
  <div id="points"></div>
  <div id="streak"></div>
  <div id="challenge"></div>
</div>

<div id="status">üì° Waiting for GPS‚Ä¶</div>

<audio id="ding" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>

<script>
/***********************
 * HELPERS
 ***********************/
const getInt = (k,d)=>isNaN(parseInt(localStorage.getItem(k)))?d:parseInt(localStorage.getItem(k));
const today = new Date().toDateString();

/***********************
 * STATE
 ***********************/
let points = getInt("points",0);
let level = getInt("level",1);
let streak = getInt("streak",1);
let lastDay = localStorage.getItem("lastDay");
let collectedIds = JSON.parse(localStorage.getItem("collectedIds")||"[]");

/***********************
 * DAILY RESET
 ***********************/
if(!lastDay){
  localStorage.setItem("lastDay", today);
  localStorage.setItem("streak", streak);
}else if(lastDay !== today){
  streak++;
  localStorage.setItem("streak", streak);
  localStorage.setItem("lastDay", today);
  collectedIds=[];
  localStorage.removeItem("collectedIds");
  localStorage.removeItem("dailyChallenge");
  localStorage.removeItem("dailyProgress");
  localStorage.removeItem("dailyDone");
}

/***********************
 * RARITIES
 ***********************/
const RARITIES={
  common:{color:"yellow",points:100},
  rare:{color:"deepskyblue",points:250},
  epic:{color:"violet",points:500}
};

/***********************
 * DAILY CHALLENGE
 ***********************/
const challengeTypes=[
  {id:"collect_common",text:"Collect 3 Common items",target:3},
  {id:"collect_rare",text:"Collect 1 Rare item",target:1},
  {id:"earn_points",text:"Earn 500 points",target:500}
];

let dailyChallenge=JSON.parse(localStorage.getItem("dailyChallenge"));
let dailyProgress=getInt("dailyProgress",0);
let dailyDone=localStorage.getItem("dailyDone")==="true";

if(!dailyChallenge){
  dailyChallenge=challengeTypes[Math.floor(Math.random()*challengeTypes.length)];
  localStorage.setItem("dailyChallenge",JSON.stringify(dailyChallenge));
  localStorage.setItem("dailyProgress",0);
  localStorage.setItem("dailyDone","false");
}

/***********************
 * MAP (DO NOT CENTER YET)
 ***********************/
const map=L.map("map");
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

let playerMarker=null;
let hasCentered=false;

/***********************
 * UI
 ***********************/
function updateUI(){
  level=Math.floor(points/500)+1;
  localStorage.setItem("points",points);
  localStorage.setItem("level",level);

  document.getElementById("level").textContent=`Level ${level}`;
  document.getElementById("points").textContent=`Points ${points}`;
  document.getElementById("streak").textContent=`üî• ${streak} Day Streak`;

  const c=document.getElementById("challenge");
  if(dailyDone){
    c.textContent=`‚úÖ ${dailyChallenge.text}`;
  }else{
    c.textContent=`üéØ ${dailyChallenge.text} (${dailyProgress}/${dailyChallenge.target})`;
  }
}
updateUI();

/***********************
 * AUDIO
 ***********************/
const playDing=()=>document.getElementById("ding").play();

/***********************
 * CHALLENGE CHECK
 ***********************/
function checkChallenge(type,amount=1){
  if(dailyDone) return;
  if(dailyChallenge.id===type){
    dailyProgress+=amount;
    localStorage.setItem("dailyProgress",dailyProgress);
    if(dailyProgress>=dailyChallenge.target){
      dailyDone=true;
      localStorage.setItem("dailyDone","true");
      points+=300;
      playDing();
    }
    updateUI();
  }
}

/***********************
 * COLLECTIBLES
 ***********************/
const collectibles=[];
map.on("click",e=>{
  let r="common";
  const roll=Math.random();
  if(roll>0.9) r="epic";
  else if(roll>0.7) r="rare";

  const c={lat:e.latlng.lat,lng:e.latlng.lng,rarity:r,collected:false};
  c.marker=L.circleMarker([c.lat,c.lng],{
    radius:9,
    color:RARITIES[r].color,
    fillColor:RARITIES[r].color,
    fillOpacity:0.9
  }).addTo(map);
  collectibles.push(c);
});

/***********************
 * GPS
 ***********************/
function dist(a,b,c,d){
  const R=6371000,toRad=x=>x*Math.PI/180;
  const dLat=toRad(c-a),dLng=toRad(d-b);
  const x=Math.sin(dLat/2)**2+
    Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dLng/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

navigator.geolocation.watchPosition(
pos=>{
  const lat=pos.coords.latitude;
  const lng=pos.coords.longitude;

  document.getElementById("status").textContent=
    `üìç Accuracy ${Math.round(pos.coords.accuracy)}m`;

  if(!playerMarker){
    playerMarker=L.circleMarker([lat,lng],{
      radius:6,color:"lime",fillOpacity:1
    }).addTo(map);
  }else{
    playerMarker.setLatLng([lat,lng]);
  }

  if(!hasCentered){
    map.setView([lat,lng],18);
    hasCentered=true;
  }

  collectibles.forEach(c=>{
    if(c.collected) return;
    if(dist(lat,lng,c.lat,c.lng)<25){
      c.collected=true;
      map.removeLayer(c.marker);
      points+=RARITIES[c.rarity].points;
      playDing();

      if(c.rarity==="common") checkChallenge("collect_common");
      if(c.rarity==="rare") checkChallenge("collect_rare");
      checkChallenge("earn_points",RARITIES[c.rarity].points);

      updateUI();
    }
  });
},
err=>{
  document.getElementById("status").textContent="‚ùå GPS unavailable";
  console.error(err);
},
{enableHighAccuracy:true}
);
</script>
</body>
</html>
