<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Snow AR Game – Stable Visual Build</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  overflow: hidden;
  background: #000;
  font-family: system-ui, sans-serif;
}

/* CAMERA */
#cameraFeed {
  position: fixed;
  inset: 0;
  object-fit: cover;
  display: none;
  z-index: 0;
}

/* MAP */
#map {
  position: fixed;
  inset: 0;
  z-index: 1;
}

/* AR OVERLAY */
#arOverlay {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 3;
}

/* AR COLLECTIBLE */
.ar-item {
  position: absolute;
  left: 50%;
  top: 50%;
  transform-origin: center;
  text-align: center;
  font-size: 28px;
  color: gold;
  text-shadow: 0 0 10px rgba(255,215,0,0.8);
}

/* HUD */
#hud {
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 4;
  background: rgba(0,0,0,0.7);
  padding: 8px;
  border-radius: 8px;
  color: #0ff;
  font-size: 14px;
}

button {
  margin-top: 6px;
  background: none;
  border: 1px solid #0ff;
  color: #0ff;
  padding: 4px 8px;
  border-radius: 6px;
}
</style>
</head>

<body>

<video id="cameraFeed" autoplay playsinline muted></video>
<div id="map"></div>
<div id="arOverlay"></div>

<div id="hud">
  <div>Points: <span id="points">0</span></div>
  <div>Level: <span id="level">1</span></div>
  <div>Run Time: <span id="runTime">0</span>s</div>
  <button id="toggleAR">Enable AR</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* =========================
   CORE STATE
========================= */
let map;
let userLat = null, userLng = null, userHeading = 0;
let userMarker = null;
let arEnabled = false;

let points = parseInt(localStorage.getItem("points")) || 0;
let level = parseInt(localStorage.getItem("level")) || 1;

const collectibles = [];
const COLLECT_RADIUS = 10;

/* =========================
   UI
========================= */
const pointsEl = document.getElementById("points");
const levelEl = document.getElementById("level");
pointsEl.textContent = points;
levelEl.textContent = level;

/* =========================
   MAP
========================= */
map = L.map("map").setView([0,0], 18);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19
}).addTo(map);

/* User marker */
userMarker = L.circleMarker([0,0], {
  radius: 8,
  color: "#0ff",
  fillColor: "#0ff",
  fillOpacity: 1
}).addTo(map);

/* Place collectibles */
map.on("click", e => {
  if (arEnabled) return;

  const marker = L.circleMarker(e.latlng, {
    radius: 6,
    color: "gold",
    fillColor: "gold",
    fillOpacity: 1
  }).addTo(map);

  collectibles.push({
    lat: e.latlng.lat,
    lng: e.latlng.lng,
    collected: false,
    marker
  });
});

/* =========================
   GPS + HEADING
========================= */
navigator.geolocation.watchPosition(
  pos => {
    userLat = pos.coords.latitude;
    userLng = pos.coords.longitude;
    if (pos.coords.heading !== null) {
      userHeading = pos.coords.heading;
    }

    userMarker.setLatLng([userLat, userLng]);
    map.setView([userLat, userLng]);
    checkCollectibles();
  },
  err => console.warn(err),
  { enableHighAccuracy: true, maximumAge: 500 }
);

/* =========================
   DISTANCE
========================= */
function distanceMeters(aLat,aLng,bLat,bLng) {
  const R = 6371000;
  const dLat = (bLat-aLat)*Math.PI/180;
  const dLng = (bLng-aLng)*Math.PI/180;
  const x =
    Math.sin(dLat/2)**2 +
    Math.cos(aLat*Math.PI/180) *
    Math.cos(bLat*Math.PI/180) *
    Math.sin(dLng/2)**2;
  return 2 * R * Math.atan2(Math.sqrt(x), Math.sqrt(1-x));
}

/* =========================
   COLLECT LOGIC
========================= */
function checkCollectibles() {
  if (!userLat) return;

  collectibles.forEach(c => {
    if (c.collected) return;

    const d = distanceMeters(userLat,userLng,c.lat,c.lng);
    if (d < COLLECT_RADIUS) {
      c.collected = true;
      if (c.marker) map.removeLayer(c.marker);
      awardPoints(10);
    }
  });
}

function awardPoints(p) {
  points += p;
  if (points >= level * 100) level++;
  pointsEl.textContent = points;
  levelEl.textContent = level;
  localStorage.setItem("points", points);
  localStorage.setItem("level", level);
}

/* =========================
   AR VISUALS
========================= */
const arOverlay = document.getElementById("arOverlay");

function updateAR() {
  arOverlay.innerHTML = "";
  if (!arEnabled || !userLat) return;

  collectibles.forEach(c => {
    if (c.collected) return;

    const d = distanceMeters(userLat,userLng,c.lat,c.lng);

    const bearing = Math.atan2(
      Math.sin((c.lng-userLng)*Math.PI/180) * Math.cos(c.lat*Math.PI/180),
      Math.cos(userLat*Math.PI/180)*Math.sin(c.lat*Math.PI/180) -
      Math.sin(userLat*Math.PI/180)*Math.cos(c.lat*Math.PI/180) *
      Math.cos((c.lng-userLng)*Math.PI/180)
    ) * 180/Math.PI;

    const rel = ((bearing - userHeading + 540) % 360) - 180;

    const el = document.createElement("div");
    el.className = "ar-item";
    el.style.transform =
      `translate(-50%, -50%) rotate(${rel}deg) translateY(-140px)`;
    el.innerHTML = `⭐<br><span style="font-size:14px">${Math.round(d)}m</span>`;
    arOverlay.appendChild(el);
  });

  requestAnimationFrame(updateAR);
}

/* =========================
   AR TOGGLE
========================= */
const cam = document.getElementById("cameraFeed");
const toggleAR = document.getElementById("toggleAR");

async function startAR() {
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" }
  });
  cam.srcObject = stream;
  cam.style.display = "block";
  map.getContainer().style.opacity = "0";
  map.getContainer().style.pointerEvents = "none";
  arEnabled = true;
  updateAR();
}

function stopAR() {
  if (cam.srcObject) cam.srcObject.getTracks().forEach(t=>t.stop());
  cam.srcObject = null;
  cam.style.display = "none";
  map.getContainer().style.opacity = "1";
  map.getContainer().style.pointerEvents = "auto";
  arEnabled = false;
}

toggleAR.onclick = () => {
  arEnabled ? stopAR() : startAR();
  toggleAR.textContent = arEnabled ? "Disable AR" : "Enable AR";
};

/* =========================
   RUN TIMER
========================= */
let runStart = null;
setInterval(() => {
  if (!userLat) return;
  if (!runStart) runStart = Date.now();
  document.getElementById("runTime").textContent =
    Math.floor((Date.now()-runStart)/1000);
}, 1000);
</script>

</body>
</html>
