<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SnowMap ‚Äì GPS Fixed + Ghost Runs</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  font-family: system-ui, sans-serif;
}

#map { height: 100%; }

#hud {
  position: fixed;
  top: 10px;
  left: 10px;
  background: rgba(0,0,0,0.7);
  color: white;
  padding: 10px;
  border-radius: 8px;
  z-index: 1000;
  font-size: 14px;
}

#hud button {
  margin-top: 6px;
  width: 100%;
}

#runSummary, #runHistory {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
}

.panel {
  background: #111;
  color: white;
  padding: 20px;
  border-radius: 12px;
  width: 90%;
  max-width: 420px;
  max-height: 80%;
  overflow-y: auto;
}

.runItem {
  border-bottom: 1px solid #333;
  padding: 8px 0;
}
</style>
</head>

<body>

<div id="map"></div>

<div id="hud">
  Points: <span id="points">0</span><br>
  Level: <span id="level">1</span><br>
  Status: <span id="status">Initializing GPS‚Ä¶</span><br>
  <button onclick="openRunHistory()">üìò Runs</button>
</div>

<div id="runSummary">
  <div class="panel">
    <h2>üèÅ Run Complete</h2>
    <p id="runStats"></p>
    <input id="runNameInput" placeholder="Name this run">
    <button onclick="saveRun()">Save Run</button>
  </div>
</div>

<div id="runHistory">
  <div class="panel">
    <h2>üìò Run History</h2>
    <div id="runList"></div>
    <button onclick="closeRunHistory()">Close</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ======================
// MAP (lazy init)
// ======================
let map;
let userMarker;
let ghostLine;

// ======================
// STATE
// ======================
let points = Number(localStorage.getItem("points")) || 0;
let level = Number(localStorage.getItem("level")) || 1;
let lastPosition = null;
let run = null;
let stationarySeconds = 0;

document.getElementById("points").textContent = points;
document.getElementById("level").textContent = level;

// ======================
// LEVELS
// ======================
function updateLevel() {
  const newLevel = Math.floor(points / 100) + 1;
  if (newLevel !== level) {
    level = newLevel;
    localStorage.setItem("level", level);
    document.getElementById("level").textContent = level;
  }
}

// ======================
// RUNS
// ======================
function startRun(pos) {
  run = {
    start: Date.now(),
    distance: 0,
    path: [[pos.lat, pos.lng]],
    date: new Date().toLocaleString(),
    name: generateRunName()
  };

  drawGhost();
}

function endRun() {
  if (!run) return;

  const time = Math.floor((Date.now() - run.start) / 1000);
  document.getElementById("runStats").innerHTML =
    `Time: ${time}s<br>Distance: ${run.distance.toFixed(1)} m`;

  document.getElementById("runNameInput").value = run.name;
  document.getElementById("runSummary").style.display = "flex";
}

function saveRun() {
  const runs = JSON.parse(localStorage.getItem("runs")) || [];
  run.name = document.getElementById("runNameInput").value;
  runs.push(run);
  localStorage.setItem("runs", JSON.stringify(runs));

  run = null;
  stationarySeconds = 0;

  document.getElementById("runSummary").style.display = "none";
}

function generateRunName() {
  const names = ["Powderline", "Frostbite", "White Rush", "Stormpath"];
  return names[Math.floor(Math.random() * names.length)];
}

// ======================
// GHOST RUN
// ======================
function drawGhost() {
  const runs = JSON.parse(localStorage.getItem("runs")) || [];
  if (runs.length === 0) return;

  const best = runs.reduce((a,b) => b.distance > a.distance ? b : a);

  if (ghostLine) map.removeLayer(ghostLine);

  ghostLine = L.polyline(best.path, {
    color: '#00ffff',
    weight: 4,
    opacity: 0.35,
    dashArray: '6,6'
  }).addTo(map);
}

// ======================
// RUN HISTORY UI
// ======================
function openRunHistory() {
  const list = document.getElementById("runList");
  list.innerHTML = "";

  const runs = JSON.parse(localStorage.getItem("runs")) || [];
  if (runs.length === 0) {
    list.innerHTML = "<p>No runs yet.</p>";
  } else {
    runs.forEach(r => {
      const d = document.createElement("div");
      d.className = "runItem";
      d.innerHTML = `<strong>${r.name}</strong><br>${r.date}<br>${r.distance.toFixed(1)} m`;
      list.appendChild(d);
    });
  }

  document.getElementById("runHistory").style.display = "flex";
}

function closeRunHistory() {
  document.getElementById("runHistory").style.display = "none";
}

// ======================
// GPS (FIXED)
// ======================
navigator.geolocation.watchPosition(pos => {
  const lat = pos.coords.latitude;
  const lng = pos.coords.longitude;

  document.getElementById("status").textContent = "GPS Active";

  if (!map) {
    map = L.map('map').setView([lat, lng], 18);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    userMarker = L.circleMarker([lat, lng], { radius: 8, color: '#00ffff' }).addTo(map);
    lastPosition = [lat, lng];
    return;
  }

  userMarker.setLatLng([lat, lng]);
  map.panTo([lat, lng], { animate: false });

  const distance = map.distance([lat, lng], lastPosition);

  if (!run && distance > 8) startRun({lat, lng});

  if (run) {
    run.distance += distance;
    run.path.push([lat, lng]);

    if (distance < 0.5) {
      stationarySeconds++;
      if (stationarySeconds >= 10) endRun();
    } else {
      stationarySeconds = 0;
    }
  }

  lastPosition = [lat, lng];

}, err => {
  document.getElementById("status").textContent = "GPS Error";
}, {
  enableHighAccuracy: true,
  maximumAge: 0,
  timeout: 15000
});
</script>

</body>
</html>
