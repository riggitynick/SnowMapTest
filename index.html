<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AR Outdoor Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html, body { margin:0; padding:0; height:100%; }
#map { height:100%; }

#hud {
  position: fixed;
  top: 10px;
  left: 10px;
  background: rgba(0,0,0,0.7);
  color: white;
  padding: 12px;
  border-radius: 12px;
  font-family: system-ui, sans-serif;
  z-index: 1000;
}

#radar {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 140px;
  height: 140px;
  border-radius: 50%;
  border: 2px solid lime;
  background: rgba(0,255,0,0.08);
  z-index: 1000;
  overflow: hidden;
}

.radar-dot {
  position: absolute;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  transform: translate(-50%, -50%);
}

/* Direction arrow */
#arrow {
  position: fixed;
  bottom: 190px;
  right: 65px;
  width: 0;
  height: 0;
  border-left: 15px solid transparent;
  border-right: 15px solid transparent;
  border-bottom: 30px solid orange;
  transform-origin: 50% 70%;
  z-index: 1000;
}

#status {
  position: fixed;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.7);
  color: white;
  padding: 6px 10px;
  border-radius: 10px;
  font-size: 12px;
  z-index: 1000;
}
</style>
</head>

<body>
<div id="map"></div>

<div id="hud">
  <div id="level"></div>
  <div id="points"></div>
  <div id="streak"></div>
</div>

<div id="arrow"></div>
<div id="radar"></div>
<div id="status">üì° Waiting for GPS‚Ä¶</div>

<audio id="ding" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>

<script>
/* =====================
   STATE
===================== */
let points = parseInt(localStorage.getItem("points")) || 0;
let level = parseInt(localStorage.getItem("level")) || 1;

/* Daily streak */
const today = new Date().toDateString();
const lastDay = localStorage.getItem("lastPlayDay");
let streak = parseInt(localStorage.getItem("streak")) || 0;

if (lastDay !== today) {
  streak += 1;
  localStorage.setItem("streak", streak);
  localStorage.setItem("lastPlayDay", today);
}

const RARITIES = {
  common: { color: "yellow", points: 100 },
  rare: { color: "deepskyblue", points: 250 },
  epic: { color: "violet", points: 500 }
};

const collectibles = [];
let playerLat = null;
let playerLng = null;

/* =====================
   MAP
===================== */
const map = L.map("map");
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19
}).addTo(map);

let playerMarker = null;
let centered = false;

/* =====================
   BIOME ZONES
===================== */
const biomes = [
  { name: "Park", circle: null }
];

/* =====================
   UI
===================== */
function updateUI() {
  level = Math.floor(points / 500) + 1;
  localStorage.setItem("points", points);
  localStorage.setItem("level", level);

  document.getElementById("level").textContent = `Level ${level}`;
  document.getElementById("points").textContent = `Points ${points}`;
  document.getElementById("streak").textContent = `üî• ${streak} Day Streak`;
}
updateUI();

/* =====================
   HELPERS
===================== */
const playDing = () => document.getElementById("ding").play();

function distance(a,b,c,d){
  const R=6371000,toRad=x=>x*Math.PI/180;
  const dLat=toRad(c-a),dLng=toRad(d-b);
  const x=Math.sin(dLat/2)**2+
    Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dLng/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

function bearing(lat1,lon1,lat2,lon2){
  const toRad=x=>x*Math.PI/180,toDeg=x=>x*180/Math.PI;
  const y=Math.sin(toRad(lon2-lon1))*Math.cos(toRad(lat2));
  const x=Math.cos(toRad(lat1))*Math.sin(toRad(lat2))-
          Math.sin(toRad(lat1))*Math.cos(toRad(lat2))*Math.cos(toRad(lon2-lon1));
  return (toDeg(Math.atan2(y,x))+360)%360;
}

/* =====================
   RADAR
===================== */
function updateRadar(){
  const radar=document.getElementById("radar");
  radar.innerHTML="";
  if(playerLat===null) return;

  const maxRange=120;
  const size=140;
  const center=size/2;

  collectibles.forEach(c=>{
    if(c.collected) return;
    const d=distance(playerLat,playerLng,c.lat,c.lng);
    if(d>maxRange) return;

    const angle=bearing(playerLat,playerLng,c.lat,c.lng)*Math.PI/180;
    const r=(d/maxRange)*(center-8);

    const dot=document.createElement("div");
    dot.className="radar-dot";
    dot.style.left=(center + r*Math.sin(angle))+"px";
    dot.style.top=(center - r*Math.cos(angle))+"px";
    dot.style.background=RARITIES[c.rarity].color;
    radar.appendChild(dot);
  });
}

/* =====================
   DIRECTION ARROW
===================== */
function updateArrow(){
  if(playerLat===null) return;

  let nearest=null;
  let nearestDist=Infinity;

  collectibles.forEach(c=>{
    if(c.collected) return;
    const d=distance(playerLat,playerLng,c.lat,c.lng);
    if(d<nearestDist){
      nearest=c;
      nearestDist=d;
    }
  });

  if(!nearest) return;

  const angle=bearing(playerLat,playerLng,nearest.lat,nearest.lng);
  document.getElementById("arrow").style.transform =
    `rotate(${angle}deg)`;
}

/* =====================
   ADD COLLECTIBLES
===================== */
map.on("click",e=>{
  let rarity="common";
  const roll=Math.random();
  if(roll>0.9) rarity="epic";
  else if(roll>0.7) rarity="rare";

  const c={
    lat:e.latlng.lat,
    lng:e.latlng.lng,
    rarity,
    collected:false
  };

  c.marker=L.circleMarker([c.lat,c.lng],{
    radius:9,
    color:RARITIES[rarity].color,
    fillOpacity:0.9
  }).addTo(map);

  collectibles.push(c);
});

/* =====================
   GPS (FIXED)
===================== */
navigator.geolocation.watchPosition(
  pos=>{
    playerLat=pos.coords.latitude;
    playerLng=pos.coords.longitude;

    document.getElementById("status").textContent =
      `üìç Accuracy ${Math.round(pos.coords.accuracy)}m`;

    if(!playerMarker){
      playerMarker=L.circleMarker([playerLat,playerLng],{
        radius:6,color:"lime",fillOpacity:1
      }).addTo(map);
    } else {
      playerMarker.setLatLng([playerLat,playerLng]);
    }

    if(!centered){
      map.setView([playerLat,playerLng],18);
      centered=true;

      const park=L.circle([playerLat,playerLng],{
        radius:80,
        color:"green",
        fillOpacity:0.1
      }).addTo(map);
      biomes[0].circle=park;
    }

    collectibles.forEach(c=>{
      if(c.collected) return;
      if(distance(playerLat,playerLng,c.lat,c.lng)<30){
        c.collected=true;
        map.removeLayer(c.marker);
        points+=RARITIES[c.rarity].points;
        playDing();
        updateUI();
      }
    });

    updateRadar();
    updateArrow();
  },
  err=>{
    document.getElementById("status").textContent="‚ùå GPS error";
    console.error(err);
  },
  {
    enableHighAccuracy:true,
    maximumAge:0,
    timeout:5000
  }
);
</script>
</body>
</html>
