<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mountain AR Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html, body { margin:0; padding:0; height:100%; }
#map { height:100%; }

#hud {
  position: fixed;
  top: 10px;
  left: 10px;
  background: rgba(0,0,0,0.7);
  color: white;
  padding: 12px;
  border-radius: 14px;
  font-family: system-ui, sans-serif;
  z-index: 1000;
}

#radar {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 140px;
  height: 140px;
  border-radius: 50%;
  border: 2px solid lime;
  background: rgba(0,255,0,0.08);
  z-index: 1000;
}

.radar-dot {
  position: absolute;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  transform: translate(-50%, -50%);
}

#arrow {
  position: fixed;
  bottom: 190px;
  right: 65px;
  width: 0;
  height: 0;
  border-left: 18px solid transparent;
  border-right: 18px solid transparent;
  border-bottom: 36px solid cyan;
  transform-origin: 50% 70%;
  z-index: 1000;
}

@keyframes pulse {
  0% { transform: scale(1) rotate(var(--angle)); opacity: 0.6; }
  50% { transform: scale(1.4) rotate(var(--angle)); opacity: 1; }
  100% { transform: scale(1) rotate(var(--angle)); opacity: 0.6; }
}

#status {
  position: fixed;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.7);
  color: white;
  padding: 6px 12px;
  border-radius: 10px;
  font-size: 12px;
  z-index: 1000;
}
</style>
</head>

<body>
<div id="map"></div>

<div id="hud">
  <div id="level"></div>
  <div id="points"></div>
  <div id="streak"></div>
  <div id="challenge"></div>
  <div id="run"></div>
</div>

<div id="arrow"></div>
<div id="radar"></div>
<div id="status">ðŸ“¡ Waiting for GPSâ€¦</div>

<audio id="ding" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
<audio id="pulse" src="https://actions.google.com/sounds/v1/alarms/heartbeat.ogg" loop></audio>

<script>
/* =====================
   CORE STATE
===================== */
let points = parseInt(localStorage.getItem("points")) || 0;
let level = Math.floor(points / 500) + 1;
let streak = parseInt(localStorage.getItem("streak")) || 1;

const today = new Date().toDateString();
if (localStorage.getItem("lastPlayDay") !== today) {
  streak++;
  localStorage.setItem("streak", streak);
  localStorage.setItem("lastPlayDay", today);
}

const collectibles = [];
let playerLat=null, playerLng=null;

/* =====================
   RUN TRACKING
===================== */
let runActive = false;
let runDistance = 0;
let runCollects = 0;
let lastRunLatLng = null;

/* =====================
   BIOMES & CHALLENGE
===================== */
const challengeKey="dailyChallenge";
let challenge=JSON.parse(localStorage.getItem(challengeKey))||{
  date:today, biome:"forest", progress:0, goal:3, completed:false
};

/* =====================
   LIFTS
===================== */
const lifts=[{start:[45.51,-122.02],end:[45.53,-122.03],radius:80}];

function inLiftZone(){
  if(!playerLat) return false;
  return lifts.some(l=>{
    return distance(playerLat,playerLng,l.start[0],l.start[1])<l.radius;
  });
}

/* =====================
   MAP
===================== */
const map=L.map("map");
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);
let playerMarker=null, centered=false;

/* =====================
   UI
===================== */
function updateUI(){
  level=Math.floor(points/500)+1;
  localStorage.setItem("points",points);
  document.getElementById("level").textContent=`Level ${level}`;
  document.getElementById("points").textContent=`Points ${points}`;
  document.getElementById("streak").textContent=`ðŸ”¥ ${streak} Day Streak`;
  document.getElementById("run").textContent=
    runActive ? `ðŸ‚ Run: ${Math.round(runDistance)}m | ðŸŽ¯ ${runCollects}` : "";
}
updateUI();

/* =====================
   HELPERS
===================== */
const pulseSound=document.getElementById("pulse");
function distance(a,b,c,d){
  const R=6371000,toRad=x=>x*Math.PI/180;
  const dLat=toRad(c-a),dLng=toRad(d-b);
  const x=Math.sin(dLat/2)**2+
    Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dLng/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

/* =====================
   GPS + GAME LOOP
===================== */
navigator.geolocation.watchPosition(
pos=>{
  playerLat=pos.coords.latitude;
  playerLng=pos.coords.longitude;
  document.getElementById("status").textContent=inLiftZone()?"ðŸš  Lift Zone":"ðŸ‚ Riding";

  if(!playerMarker){
    playerMarker=L.circleMarker([playerLat,playerLng],{radius:6,color:"lime"}).addTo(map);
  } else playerMarker.setLatLng([playerLat,playerLng]);

  if(!centered){ map.setView([playerLat,playerLng],18); centered=true; }

  // RUN START
  if(!runActive && !inLiftZone()){
    runActive=true;
    runDistance=0;
    runCollects=0;
    lastRunLatLng=[playerLat,playerLng];
  }

  // RUN TRACKING
  if(runActive && lastRunLatLng){
    runDistance+=distance(lastRunLatLng[0],lastRunLatLng[1],playerLat,playerLng);
    lastRunLatLng=[playerLat,playerLng];
  }

  // RUN END
  if(runActive && inLiftZone()){
    const bonus=Math.round(runDistance/10)+(runCollects*100);
    points+=bonus;
    runActive=false;
    updateUI();
  }

  // HOT / COLD
  let nearest=Infinity;
  collectibles.forEach(c=>{
    if(c.collected) return;
    const d=distance(playerLat,playerLng,c.lat,c.lng);
    nearest=Math.min(nearest,d);
    if(d<25){
      c.collected=true;
      map.removeLayer(c.marker);
      points+=100;
      runCollects++;
      updateUI();
      document.getElementById("ding").play();
    }
  });

  if(nearest<200){
    pulseSound.playbackRate=Math.max(0.5,2-(nearest/100));
    pulseSound.play();
  } else pulseSound.pause();

},
err=>console.error(err),
{enableHighAccuracy:true,maximumAge:0,timeout:5000}
);

/* =====================
   SPAWN
===================== */
map.on("click",e=>{
  const c={lat:e.latlng.lat,lng:e.latlng.lng,collected:false};
  c.marker=L.circleMarker([c.lat,c.lng],{radius:9,color:"cyan"}).addTo(map);
  collectibles.push(c);
});
</script>
</body>
</html>
